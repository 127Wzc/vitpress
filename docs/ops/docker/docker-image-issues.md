---
isTimeLine: true
title: Docker镜像问题汇总
description: 最近更新⏰ 2024-10-20：更新构建镜像过程中`RUN`下载的文件丢失
date: 2024-10-20
tag: 
 - Docker
---
# Docker镜像问题汇总

## 构建镜像过程中`RUN`下载的文件丢失

### 问题描述
Dockerfile种使用`RUN`下载文件到镜像里tmp目录文件丢失，原始Dockerfile如下
```docker
FROM openjdk:8-jdk-alpine
VOLUME /tmp

RUN apk --no-cache add tzdata ttf-dejavu curl && \
    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime && \
    echo "Asia/Shanghai" > /etc/timezone

RUN wget -O /tmp/init.zip "https://xxx.cn/init.zip"

ENV JAVA_OPTS=""

EXPOSE 9000

ENTRYPOINT java ${JAVA_OPTS} -Djava.security.egd=file:/dev/./urandom -jar /app.war
```
### 问题解释
:::warning 
此处使用了`VOLUME`，`VOLUME`指令用于创建一个挂载点，允许你将主机的目录或数据卷挂载到容器内的指定目录。使用`VOLUME`指令的主要作用包括：
1. 数据持久化：通过将容器的某个目录挂载到主机的目录或数据卷，确保即使容器被删除，数据仍然保留在主机上。
2. 共享数据：多个容器可以挂载同一个数据卷，从而共享数据。
3. 隔离：使用数据卷可以将容器的文件系统与主机的文件系统分离，避免直接对主机文件系统的影响。
:::

文件丢失的问题可能与`VOLUME`的关系
如果你在Dockerfile中使用`VOLUME`指令，并且在后续的`RUN`指令中下载文件到这个挂载的目录，文件丢失的原因可能与以下几点有关：
- 挂载点的影响：
  当你在Dockerfile中使用`VOLUME`指令指定一个目录后，Docker会在构建时将该目录标记为挂载点。在构建过程中，这个目录会被视为一个空的挂载点。因此，在这个目录中创建的任何文件都不会被保留，因为在容器运行时，挂载的目录会覆盖这个路径。
- 构建与运行的区别：
  `RUN`指令是在构建镜像时执行的，而`VOLUME`指令的效果在运行容器时才会生效。这意味着在构建过程中，任何写入到挂载目录的文件在容器运行时会被清空。


### 扩展`COPY`和`RUN`指令
- RUN 指令用于在镜像中执行命令。这些命令通常用于安装软件包、配置环境或者执行其他需要在构建时运行的脚本。例如，`RUN apt-get update && apt-get install -y python3` 用于在镜像中安装 Python 3。

- `COPY`指令用于将文件或目录从构建上下文（即 Dockerfile 所在目录）复制到镜像中。它主要用于将应用程序代码、配置文件或者其他需要包含在镜像中的静态资源添加到镜像中。

#### `COPY`指令的行为

**1.文件复制到镜像中**  
`COPY`指令将文件从构建上下文（即执行 `docker build` 命令的目录）复制到目标的文件系统中。这个操作是直接在构建镜像的过程中进行的，因此文件会被永久地嵌入到镜像中，成为镜像的一部分。

**2.无视挂载点**  
当使用`COPY`指令将文件复制到挂载点时，这些文件会被复制到镜像的层里而不是挂载点里。而挂载点是在容器运行时才会被挂载的。因此在构建镜像时，挂载点的存在与否不会影响文件的复制。

#### `RUN`指令的行为

**1.构建时的行为**  
RUN 指令在构建镜像时执行命令，其结果（如指定命令生成的文件）会被存储在镜像中。只有在镜像构建成功后，这些结果才会成为镜像的一部分。`Docker`的每个`RUN`指令都会生成一个新的镜像层。

**2.容器运行时的行为**  
在Dockerfile中使用`RUN`指令生成的文件会被包含在镜像中。当容器运行时，这些文件会在容器的文件系统中出现。即使挂载点被挂载，`RUN`指令生成的文件仍然会保留在镜像层中，不会被挂载卷覆盖。

### 解决方案
如果你希望在构建过程中下载的文件能够在最终镜像中保留，建议不要将该目录标记为`VOLUME`，或者在下载后立即将文件复制到一个非挂载的目录。
- `VOLUME`指令用于创建挂载点，主要用于数据持久化和共享。
- 在构建过程中，挂载目录会被视为空的，因此在此目录中创建的文件可能会丢失。
- 如果希望在镜像中保留文件，避免在构建过程中将目录标记为`VOLUME`，或者在下载后将文件复制到其他非挂载的目录。